<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Yearly Statistics</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">Flood Yearly Statistics</h1>
    <div class="d-flex mb-3">
        <select id="timeLapse" class="form-select w-auto">
            <option value="1">1 Year</option>
            <option value="5">5 Years</option>
            <option value="10">10 Years</option>
            <option value="15">15 Years</option>
            <option value="20">20 Years</option>
        </select>
        <div class="form-check ms-3">
            <input class="form-check-input" type="radio" name="chartDataOption" id="optionOccurrences" value="occurrences" checked>
            <label class="form-check-label" for="optionOccurrences">
                Count of Occurrences
            </label>
        </div>
        <div class="form-check ms-3">
            <input class="form-check-input" type="radio" name="chartDataOption" id="optionFatalities" value="totalFatalities">
            <label class="form-check-label" for="optionFatalities">
                Total Fatalities
            </label>
        </div>
        <div class="form-check ms-3">
            <input class="form-check-input" type="radio" name="chartDataOption" id="optionPersonsAffected" value="totalPersonsAffected">
            <label class="form-check-label" for="optionPersonsAffected">
                Total Persons Affected
            </label>
        </div>
        <div class="form-check ms-3">
            <input class="form-check-input" type="radio" name="chartDataOption" id="optionLosses" value="totalLosses">
            <label class="form-check-label" for="optionLosses">
                Total Losses
            </label>
        </div>
    </div>
    <div id="statsTable"></div>
    <canvas id="floodChart" class="my-4"></canvas>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- PapaParse JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom JS -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Load data when the document is ready
        loadData();
    });

    let parsedCSVData = null; // Store parsed CSV data
    let floodChartInstance = null;

    function loadData() {
        const filePath = 'hanze_11259233_Version_v2.1.2/HANZE_events.csv';
        fetch(filePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.text();
            })
            .then(csvText => {
                // Parse the CSV using PapaParse
                Papa.parse(csvText, {
                    header: true,
                    complete: function (results) {
                        if (results.errors.length) {
                            console.error("CSV Parsing Errors:", results.errors);
                        } else {
                            parsedCSVData = results.data;
                            processCSVData(parsedCSVData); // Process data after parsing
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading the CSV file:', error);
            });
    }

    function processCSVData(data) {
        const yearlyStats = {};
        const floodCounts = {};

        // Loop through data and aggregate by year
        data.forEach(row => {
            const year = parseInt(row["Year"]);
            if (!isNaN(year)) {
                if (!yearlyStats[year]) {
                    yearlyStats[year] = {
                        totalFatalities: 0,
                        totalPersonsAffected: 0,
                        totalLosses: 0
                    };
                    floodCounts[year] = 0;
                }

                yearlyStats[year].totalFatalities += parseInt(row["Fatalities"]) || 0;
                yearlyStats[year].totalPersonsAffected += parseInt(row["Persons affected"]) || 0;
                yearlyStats[year].totalLosses += parseFloat(row["Losses (2020 euro)"]) || 0;
                floodCounts[year] += 1; // Count each flood
            }
        });

        // Render chart with the processed flood data
        renderFloodChart(yearlyStats, floodCounts);
    }

    function renderFloodChart(yearlyStats, floodCounts) {
        const ctx = document.getElementById('floodChart').getContext('2d');
        const timeLapse = parseInt(document.getElementById('timeLapse').value);
        const selectedOption = document.querySelector('input[name="chartDataOption"]:checked').value;
        let dataToPlot = {};

        if (selectedOption === 'occurrences') {
            dataToPlot = groupByTimeLapse(floodCounts, timeLapse);
        } else {
            dataToPlot = groupByTimeLapse(yearlyStats, timeLapse, selectedOption);
        }

        // Get sorted years and counts to match
        const years = Object.keys(dataToPlot).sort((a, b) => a - b);
        const counts = years.map(year => dataToPlot[year]);

        // Destroy the previous chart instance if it exists
        if (floodChartInstance) {
            floodChartInstance.destroy();
        }

        // Create a new chart instance
        floodChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [{
                    label: `${selectedOption.charAt(0).toUpperCase() + selectedOption.slice(1)} (Grouped by ${timeLapse} Year(s))`,
                    data: counts,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function groupByTimeLapse(data, timeLapse, key = null) {
        const groupedData = {};
        const years = Object.keys(data).map(year => parseInt(year)).sort((a, b) => a - b);

        years.forEach(year => {
            const groupYear = Math.floor(year / timeLapse) * timeLapse;
            if (!groupedData[groupYear]) {
                groupedData[groupYear] = 0;
            }
            groupedData[groupYear] += key ? (data[year][key] || 0) : data[year];
        });

        return groupedData;
    }

    // Update the chart when the time lapse selection or data option changes
    document.getElementById('timeLapse').addEventListener('change', function () {
        if (parsedCSVData) {
            processCSVData(parsedCSVData); // Use already parsed CSV data for faster processing
        }
    });

    document.querySelectorAll('input[name="chartDataOption"]').forEach(radio => {
        radio.addEventListener('change', function () {
            if (parsedCSVData) {
                processCSVData(parsedCSVData); // Use already parsed CSV data for faster processing
            }
        });
    });
</script>
</body>
</html>
